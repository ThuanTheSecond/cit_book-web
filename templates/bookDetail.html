{% extends "base.html" %}
{% load static %}
{% load widget_tweaks %}
{% load filters %}

{% block pack %}
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel/slick/slick.css"/>
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/slick-carousel/slick/slick-theme.css"/>
  <script type="text/javascript" src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/slick-carousel/slick/slick.min.js"></script>
  <link rel="stylesheet" href="{% static 'Css/customSlick.css' %}">
  <link href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
  <style>
    .custom-navbar {
        background-color: #ffffff;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 1rem 0;
        margin-bottom: 2rem;
    }

    .navbar-container {
        max-width: 1200px;
        margin: 0 auto;
        padding: 0 1rem;
        display: flex;
        justify-content: flex-end;
        align-items: center;
    }

    .navbar-nav {
        display: flex;
        gap: 2rem;
        align-items: center;
        margin: 0;
        padding: 0;
        list-style: none;
    }

    .nav-item {
        position: relative;
    }

    .nav-link {
        color: #2c3e50;
        text-decoration: none;
        font-weight: 500;
        font-size: 1rem;
        padding: 0.5rem 1rem;
        border-radius: 6px;
        transition: all 0.3s ease;
    }

    .nav-link:hover {
        color: #3498db;
        background-color: rgba(52, 152, 219, 0.1);
    }

    .nav-link.active {
        color: #3498db;
        background-color: rgba(52, 152, 219, 0.1);
    }

    .dropdown-toggle::after {
        margin-left: 0.5rem;
        vertical-align: middle;
    }

    .dropdown-menu {
        background: white;
        border-radius: 8px;
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);
        border: none;
        padding: 0.5rem;
        min-width: 200px;
        margin-top: 0.5rem;
    }

    .dropdown-menu::before {
        content: '';
        position: absolute;
        top: -5px;
        right: 20px;
        width: 10px;
        height: 10px;
        background: white;
        transform: rotate(45deg);
        box-shadow: -2px -2px 5px rgba(0, 0, 0, 0.05);
    }

    .dropdown-item {
        padding: 0.7rem 1rem;
        color: #2c3e50;
        border-radius: 4px;
        transition: all 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: rgba(52, 152, 219, 0.1);
        color: #3498db;
    }

    @media (max-width: 768px) {
        .navbar-container {
            flex-direction: column;
            align-items: flex-start;
        }

        .navbar-nav {
            flex-direction: column;
            width: 100%;
            gap: 1rem;
        }

        .dropdown-menu {
            width: 100%;
            margin-top: 0;
        }

        .dropdown-menu::before {
            display: none;
        }
    }

    .right-container {
        padding: 2rem;
    }

    .book-details-wrapper {
        background: white;
        padding: 2rem;
        border-radius: 12px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
    }

    .book-title {
        font-size: 2.2rem;
        font-weight: 700;
        color: #2c3e50;
        margin-bottom: 1.5rem;
        line-height: 1.3;
    }

    .book-meta {
        margin-bottom: 2rem;
        padding-bottom: 1.5rem;
        border-bottom: 1px solid #eee;
    }

    .aveRating {
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .product-rating {
        font-size: 1.8rem;
        font-weight: 700;
        color: #2c3e50;
    }

    .rating-text {
        font-size: 1rem;
        color: #666;
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .aveRating-star {
        color: #ffd700;
        font-size: 1.2rem;
    }

    .rating-count {
        color: #666;
        font-size: 0.9rem;
    }

    .book-info-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 2rem;
    }

    .info-item {
        display: flex;
        flex-direction: column;
        gap: 0.5rem;
    }

    .info-item label {
        font-weight: 600;
        color: #666;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    .info-item p {
        font-size: 1.1rem;
        color: #2c3e50;
        margin: 0;
    }

    @media (max-width: 768px) {
        .right-container {
            padding: 1rem;
        }

        .book-details-wrapper {
            padding: 1.5rem;
        }

        .book-title {
            font-size: 1.8rem;
        }

        .book-info-grid {
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }
    }

    /* Wishlist Button Styles */
    .wishlistStyle {
        position: relative;
        padding: 12px 24px;
        font-size: 1rem;
        font-weight: 500;
        color: #2c3e50;
        background: white;
        border: 2px solid #e0e0e0;
        border-radius: 8px;
        cursor: pointer;
        overflow: hidden;
        transition: all 0.3s ease;
        width: 100%;
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 8px;
        margin: 1rem 0;
    }

    .wishlistStyle:hover {
        border-color: #4CAF50;
        background: linear-gradient(145deg, #ffffff, #f8f9fa);
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.15);
    }

    .wishlistStyle:active {
        transform: translateY(0);
    }

    .wishlistStyle.saved {
        background: #4CAF50;
        color: white;
        border-color: #4CAF50;
    }

    .wishlistStyle.saved:hover {
        background: #43A047;
        box-shadow: 0 4px 12px rgba(76, 175, 80, 0.25);
    }

    .wishlistStyle .check-icon {
        font-size: 1.1rem;
        display: inline-flex;
        align-items: center;
        transition: all 0.3s ease;
    }

    .wishlistStyle:hover .check-icon {
        transform: scale(1.1);
    }

    .wishlistStyle .save-text {
        position: relative;
        transition: all 0.3s ease;
    }

    .wishlistStyle:hover .save-text {
        transform: translateX(2px);
    }

    .wishlistStyle.loading {
        background: #f8f9fa;
        pointer-events: none;
        opacity: 0.8;
    }

    .wishlistStyle.loading::after {
        content: '';
        position: absolute;
        width: 20px;
        height: 20px;
        border: 2px solid #4CAF50;
        border-radius: 50%;
        border-top-color: transparent;
        animation: spin 0.8s linear infinite;
        right: 10px;
    }

    @keyframes spin {
        to {
            transform: rotate(360deg);
        }
    }

    .wish {
        padding: 0.5rem;
    }

    [id^="wishlist"] {
        width: 100%;
    }

    /* New Review Section Styles */
    .reviews-section {
        background: white;
        border-radius: 15px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        margin: 2rem 0;
        padding: 2rem;
    }

    .reviews-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: 2rem;
        padding-bottom: 1rem;
        border-bottom: 2px solid #f0f0f0;
    }

    .reviews-header h3 {
        font-size: 1.8rem;
        color: #2c3e50;
        margin: 0;
        font-weight: 600;
    }

    .review-stats {
        display: flex;
        align-items: center;
        gap: 1.5rem;
    }

    .review-form {
        background: #ffffff;
        border-radius: 15px;
        padding: 1.2rem;
        box-shadow: 0 5px 15px rgba(0, 0, 0, 0.05);
        transition: all 0.3s ease;
        margin-bottom: 1rem;
    }

    .review-form:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
    }

    /* Star Rating Styling */
    .rating {
        display: flex;
        flex-direction: row-reverse;
        justify-content: center;
        gap: 0.3rem;
        margin: 0.8rem 0;
    }

    .rating input {
        display: none;
    }

    .rating label {
        font-size: 1.8rem;
        color: #ddd;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .rating label:hover,
    .rating label:hover ~ label,
    .rating input:checked ~ label {
        color: #ffd700;
        transform: scale(1.1);
        filter: drop-shadow(0 0 5px rgba(255, 215, 0, 0.5));
    }

    .rating:hover label {
        animation: bounce 0.3s ease-in-out;
    }

    @keyframes bounce {
        0%, 100% { transform: scale(1); }
        50% { transform: scale(1.1); }
    }

    /* Review Textarea Styling */
    .review-form textarea {
        width: 100%;
        min-height: 80px;
        padding: 0.8rem;
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        font-size: 0.95rem;
        margin: 0.5rem 0;
        transition: all 0.3s ease;
        resize: vertical;
    }

    .review-form textarea:focus {
        border-color: #4CAF50;
        box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        outline: none;
    }

    .review-form textarea::placeholder {
        color: #aaa;
    }

    /* Submit Button Styling */
    .review-form button[type="submit"] {
        background: linear-gradient(45deg, #4CAF50, #45a049);
        color: white;
        border: none;
        border-radius: 25px;
        padding: 0.6rem 1.5rem;
        font-size: 0.95rem;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
        margin: 0.8rem auto 0;
        position: relative;
        overflow: hidden;
    }

    .review-form button[type="submit"]:hover {
        transform: translateY(-2px);
        box-shadow: 0 5px 15px rgba(76, 175, 80, 0.3);
    }

    .review-form button[type="submit"]:active {
        transform: translateY(0);
    }

    .review-form button[type="submit"]::before {
        content: '';
        position: absolute;
        top: 0;
        left: -100%;
        width: 100%;
        height: 100%;
        background: linear-gradient(
            90deg,
            transparent,
            rgba(255, 255, 255, 0.2),
            transparent
        );
        transition: 0.5s;
    }

    .review-form button[type="submit"]:hover::before {
        left: 100%;
    }

    /* Animation for form appearance */
    .review-form {
        animation: slideIn 0.5s ease-out;
    }

    @keyframes slideIn {
        from {
            opacity: 0;
            transform: translateY(20px);
        }
        to {
            opacity: 1;
            transform: translateY(0);
        }
    }

    /* Responsive adjustments */
    @media (max-width: 768px) {
        .rating label {
            font-size: 2rem;
        }

        .review-form {
            padding: 1.5rem;
        }

        .review-form textarea {
            min-height: 100px;
        }
    }

    .review-item {
        background: #fff;
        border-radius: 10px;
        padding: 1.5rem;
        margin-bottom: 1rem;
        border: 1px solid #f0f0f0;
        transition: all 0.3s ease;
    }

    .review-item:hover {
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.05);
        transform: translateY(-2px);
    }

    .review-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .review-user {
        display: flex;
        align-items: center;
        gap: 1rem;
    }

    .user-avatar {
        width: 40px;
        height: 40px;
        border-radius: 50%;
        background: #e0e0e0;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .user-avatar i {
        color: #666;
        font-size: 1.2rem;
    }

    .review-user-info {
        display: flex;
        flex-direction: column;
    }

    .username {
        font-weight: 600;
        color: #2c3e50;
        margin: 0;
    }

    .review-date {
        color: #666;
        font-size: 0.9rem;
        margin: 0;
    }

    .review-rating {
        display: flex;
        align-items: center;
        gap: 0.3rem;
    }

    .review-rating i {
        color: #ffd700;
    }

    .review-content {
        color: #444;
        line-height: 1.6;
        margin: 0;
    }

    .empty-reviews {
        text-align: center;
        padding: 3rem;
        background: #f8f9fa;
        border-radius: 12px;
        margin: 2rem 0;
    }

    .empty-reviews i {
        font-size: 4rem;
        color: #ccc;
        margin-bottom: 1rem;
        display: block;
    }

    .empty-reviews h4 {
        color: #666;
        margin-bottom: 0.5rem;
    }

    .empty-reviews p {
        color: #888;
        margin: 0;
    }

    .login-prompt {
        text-align: center;
        padding: 2rem;
        background: #f8f9fa;
        border-radius: 12px;
        margin: 2rem 0;
        border: 1px dashed #ddd;
    }

    .login-prompt i {
        font-size: 2rem;
        color: #666;
        margin-bottom: 1rem;
        display: block;
    }

    .login-prompt p {
        color: #666;
        margin-bottom: 1rem;
    }

    .login-prompt a {
        color: #4CAF50;
        text-decoration: none;
        font-weight: 500;
        transition: all 0.3s ease;
    }

    .login-prompt a:hover {
        color: #43A047;
        text-decoration: underline;
    }

    @media (max-width: 768px) {
        .reviews-section {
            padding: 1rem;
        }

        .reviews-header {
            flex-direction: column;
            align-items: flex-start;
            gap: 1rem;
        }

        .review-form {
            padding: 1rem;
        }

        .stars label {
            font-size: 1.5rem;
        }

        .review-header {
            flex-direction: column;
            gap: 0.5rem;
        }
    }
  </style>
{% endblock pack %}


{% block content %}
<div class="body">
    <div class="container-fluid">
        <div class="row">
            <div class="left-container col-md-3 justify-content-center">
                <img src="{{ detail.bookImage.url }}" alt="image of book {{myManga.title}}" class="book-detail-image">

                <div class="mfn">
                    <a href="https://lrcopac.ctu.edu.vn/pages/opac/wpid-detailbib-id-{{ detail.book_slug }}.html">Thông tin thêm</a>
                </div>
                
                <div class="wish">
                    <div id='wishlist{{detail.book_id}}' hx-post="/wishCheck_post/" hx-vals='{"book_id": {{detail.book_id}}}' hx-trigger="load" hx-target='#wishlist{{detail.book_id}}' hx-swap='innerHTML'>
                        <button class="wishlistStyle{% if saved %} saved{% endif %}" 
                                hx-post="/wishList_post/" 
                                hx-vals='{"book_id": {{detail.book_id}}}' 
                                hx-trigger="click delay:0.25s" 
                                hx-target="#wishlist{{detail.book_id}}" 
                                hx-swap="innerHTML"
                                onclick="this.classList.add('loading')">
                            {% if saved %}
                                <span class="check-icon">✓</span>
                                <span class="save-text">Đã Lưu</span>
                            {% else %}
                                <i class="far fa-bookmark"></i>
                                <span class="save-text">Lưu Sách</span>
                            {% endif %}
                        </button>
                    </div>
                </div>
            </div>

            <div class="right-container col-md-9">
                <div class="book-details-wrapper">
                    <h1 class="book-title">{{detail.book_title}}</h1>
                    
                    <div class="book-meta">
                        <div class="aveRating">
                            <span class="product-rating">{{ averRate }}</span>
                            <span class="rating-text">/5 
                                <span class="fa fa-star aveRating-star"></span>
                                <span class="rating-count">({{ countRate }} người đánh giá - {{ detail.book_view }} lượt xem)</span>
                            </span>
                        </div>
                    </div>

                    <div class="book-info-grid">
                        <div class="info-item">
                            <label>Tác giả</label>
                            <p>{{detail.book_author}}</p>
                        </div>
                        <div class="info-item">
                            <label>Vị trí kệ</label>
                            <p>{{ detail.book_position }}</p>
                        </div>
                        <div class="info-item">
                            <label>Ngày xuất bản</label>
                            <p>{{ detail.book_publish }}</p>
                        </div>
                        <div class="info-item">
                            <label>MFN</label>
                            <p>{{ detail.book_MFN }}</p>
                        </div>
                    </div>
                </div>

                <!-- <div class="reviews-section p-3">
                    <div class="reviews-header d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h5 m-0">Đánh giá và Bình luận</h3>
                        <div class="aveRating">
                            <span class="product-rating">{{ averRate }}</span>
                            <span class="rating-text small">/5 
                                <i class="fas fa-star text-warning"></i>
                                <span class="rating-count">({{ countRate }} đánh giá)</span>
                            </span>
                        </div>
                    </div>
                </div> -->
            </div>
        </div>
    </div>
    <div class="suggestBook">
        <div class="container-fluid justify-content-center">
            <h5><a id="container-header" href="#">Sách tương tự</a></h5>
            <div class="book-slider">
                {% for book in bookList reversed %}
                <div class="book-item">
                    <a href="/book/detail/id={{ book.book_id|subtract:3000 }}"><img class="book-image" src="{{ book.bookImage.url }}" alt="{{ book.book_title }}"></a>
                    <h5 class="mt-2">{{ book.book_title }}</h5>
                </div>
                {% endfor %}
            </div>
        </div>
    </div>
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="reviews-section p-3">
                    <div class="reviews-header d-flex justify-content-between align-items-center mb-2">
                        <h3 class="h5 m-0">Đánh giá và Bình luận</h3>
                        <div class="aveRating">
                            <span class="product-rating">{{ averRate }}</span>
                            <span class="rating-text small">/5 
                                <i class="fas fa-star text-warning"></i>
                                <span class="rating-count">({{ countRate }} đánh giá)</span>
                            </span>
                        </div>
                    </div>
                    
                    <div class="review-section">
                        {% if user.is_authenticated %}
                            {% if user_has_reviewed %}
                                <div class="alert alert-info" role="alert">
                                    Bạn đã đánh giá cuốn sách này. Mỗi người chỉ được đánh giá một lần.
                                </div>
                            {% else %}
                                <form hx-post="{% url 'add_review' detail.book_id %}" hx-target="#reviews-list" class="review-form">
                                    {% csrf_token %}
                                    <div class="rating">
                                        <input type="radio" name="rating" value="5" id="5"><label for="5">☆</label>
                                        <input type="radio" name="rating" value="4" id="4"><label for="4">☆</label>
                                        <input type="radio" name="rating" value="3" id="3"><label for="3">☆</label>
                                        <input type="radio" name="rating" value="2" id="2"><label for="2">☆</label>
                                        <input type="radio" name="rating" value="1" id="1"><label for="1">☆</label>
                                    </div>
                                    <textarea name="comment" placeholder="Viết đánh giá của bạn..." required></textarea>
                                    <button type="submit" class="btn btn-primary">Gửi đánh giá</button>
                                </form>
                            {% endif %}
                        {% else %}
                            <p>Vui lòng <a href="{% url 'login' %}">đăng nhập</a> để đánh giá.</p>
                        {% endif %}
                        <div id="reviews-list">
                            {% include 'partials/reviews_list.html' %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 
<nav class="custom-navbar">
    <div class="navbar-container">
        <ul class="navbar-nav">
            <li class="nav-item">
                <a class="nav-link {% if request.path == '/mybook/' %}active{% endif %}" href="/mybook/">
                    <i class="fas fa-heart"></i> Wishlist của tôi
                </a>
            </li>
            <li class="nav-item dropdown">
                <a class="nav-link dropdown-toggle" href="#" id="navbarDropdownMenuLink" role="button" data-bs-toggle="dropdown" aria-expanded="false" hx-post="/topicList_post/" hx-trigger="click" hx-target="#topicList">
                    <i class="fas fa-book"></i> Thể loại sách
                </a>
                <ul class="dropdown-menu" id="topicList" aria-labelledby="navbarDropdownMenuLink">
                    
                </ul>
            </li>
        </ul>
    </div>
</nav> -->

{% endblock content %}


{% block scripts %}
<script src="https://unpkg.com/htmx.org@2.0.2/dist/htmx.js" integrity="sha384-yZq+5izaUBKcRgFbxgkRYwpHhHHCpp5nseXp0MEQ1A4MTWVMnqkmcuFez8x5qfxr"crossorigin="anonymous"></script> 
<script>
    function hidebutton(button){
        button.type = 'hidden'
    }
    function savingList(button){
        button.value ='saving...'
    } 

    // Biến để theo dõi trạng thái wishlist ban đầu
    let initialWishlistLoad = true;
    let previousButtonState = null;

    // Listen for successful wishlist updates
    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id.startsWith('wishlist')) {
            const button = evt.detail.target.querySelector('button');
            
            if (button) {
                const isCurrentlySaved = button.textContent.includes('✓');
                
                // Chỉ hiển thị toast khi:
                // 1. Không phải lần tải đầu tiên
                // 2. Button có dấu ✓
                // 3. Trạng thái trước đó của button không phải là đã lưu
                if (!initialWishlistLoad && isCurrentlySaved && previousButtonState === false) {
                    Toastify({
                        text: "Đã thêm sách vào danh sách xem sau",
                        duration: 3000,
                        gravity: "top",
                        position: "right",
                        backgroundColor: "#4CAF50",
                        stopOnFocus: true,
                    }).showToast();
                }
                
                // Cập nhật trạng thái trước đó của button
                previousButtonState = isCurrentlySaved;
            }
            
            // Đánh dấu đã qua lần tải đầu tiên
            if (initialWishlistLoad) {
                initialWishlistLoad = false;
            }
        }
    });

    // Handle review form submission
    document.body.addEventListener('htmx:beforeRequest', function(evt) {
        if (evt.detail.target.id === 'reviews-list') {
            evt.detail.target.closest('form').querySelector('button').disabled = true;
        }
    });

    document.body.addEventListener('htmx:afterRequest', function(evt) {
        if (evt.detail.target.id === 'reviews-list') {
            const form = evt.detail.target.closest('form');
            if (form) {
                form.reset();
                form.querySelector('button').disabled = false;
            }
        }
    });

    document.body.addEventListener('htmx:afterSwap', function(evt) {
        if (evt.detail.target.id === 'reviews-list') {
            // Show success toast
            Toastify({
                text: "Đánh giá của bạn đã được gửi thành công!",
                duration: 3000,
                gravity: "top",
                position: "right",
                backgroundColor: "#4CAF50",
                stopOnFocus: true,
                callback: function() {
                    // Reload page after toast disappears
                    window.location.reload();
                }
            }).showToast();
        }
    });
</script>
<script src="{% static 'Js/customSlick.js' %}"></script>

<script>
document.body.addEventListener('htmx:configRequest', function(evt) {
    // Kiểm tra xem yêu cầu có đến từ nút wishList hay không
    let target = evt.target;
    if (target && target.classList.contains('star')) {
        let hxVals = JSON.parse(target.getAttribute('hx-vals'));
        hxVals["current_url"] = window.location.href;
        target.setAttribute('hx-vals', JSON.stringify(hxVals));
        evt.detail.parameters = hxVals;
    }
});
</script>


{% endblock scripts %}
    